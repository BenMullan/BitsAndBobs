<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>paste-it</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f8f8 0%, #dcc8f0 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
            margin: 0px;
            background: white;
            box-shadow: 0 0 50px rgba(0,0,0,0.1);
        }

        .sidebar {
            width: 300px;
            background: #f8f9ff;
            border-right: 1px solid #e1e5f0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #626264, #9277c2);
            color: white;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .bucket-controls {
            padding: 15px;
            border-bottom: 1px solid #e1e5f0;
        }

        .new-bucket-btn {
            width: 100%;
            padding: 6px;
            background: #77777a;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .new-bucket-btn:hover {
            background: #2d2d2e;
        }

        .bucket-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .bucket-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e1e1e1;
            background-color: #ffffff;
        }

        .bucket-item:hover {
            background: #f0f4ff;
        }

        .bucket-item.active {
            background: #d0d8f5;
            border-color: #7974e7;
        }

        .bucket-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .bucket-info {
            font-size: 0.8em;
            color: #6b7280;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            padding: 20px;
            border-bottom: 1px solid #e1e5f0;
            background: white;
        }

        .content-header h2 {
            margin-bottom: 5px;
        }

        .paste-hint {
            color: #6b7280;
            font-size: 0.9em;
        }

        .items-container {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: #fafbff;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .item-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 10px 16px rgba(0,0,0,0.08);
            transition: all 0.15s ease;
            position: relative;
            border: 1px solid #929292;

            display: flex;
            flex-direction: column;
        }

        .item-card:hover {
            transform: scale(1.01);
            box-shadow: 0 8px 18px rgba(135, 75, 212, 0.356);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-type {
            background: #e0e7ff79;
            color: #17143375;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .item-timestamp {
            font-size: 0.75em;
            color: #b9babd;
        }

        .item-content {
            margin-bottom: 15px;
            /* display: grid; place-items: center; */
            flex: 1;
        }

        .item-text {
            font-family: 'Consolas', 'Lucida Console', monospace;
            font-size: small;
            background: #f8f9ff;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #c8c6f1;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .item-image {
            max-width: 100%;
            max-height: 230px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid #c8c6f1;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .copy-btn {
            /* flex: 1; */
            padding: 4px 8px;
            background: #2bff0042;
            color: rgb(71, 71, 71);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .copy-btn:hover {
            background: #1bc2377e;
        }

        .delete-btn {
            padding: 4px 8px;
            background: #fd727246;
            color: rgb(71, 71, 71);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .delete-btn:hover {
            background: #be292991;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #27ae60;
            color: white;
            border-radius: 4px;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            font-weight: 500;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #e74c3c;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 6px;
            max-width: 400px;
            width: 90%;
            border: 1px solid #e0e0e0;
        }

        .modal h3 {
            margin-bottom: 16px;
            color: #2c3e50;
            font-weight: 600;
        }

        .modal input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .modal input:focus {
            outline: none;
            border-color: #3498db;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background 0.2s;
        }

        .modal-btn.primary {
            background: #3498db;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #2980b9;
        }

        .modal-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .modal-btn.secondary:hover {
            background: #7f8c8d;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üìã paste-it</h1>
                <p>real-time clipboard</p>
            </div>
            
            <div class="bucket-controls">
                <button class="new-bucket-btn" onclick="showNewBucketModal()">
                    + new bucket
                </button>
            </div>
            
            <div class="bucket-list" id="bucketList">
                <div class="loading">Loading buckets...</div>
            </div>
        </div>

        <div class="main-content">
            <div class="content-header">
                <h2 id="currentBucketName" style="display: none;">Select a bucket</h2>
                <p class="paste-hint">
                    <b>Ctrl+V to paste, or drag & drop...</b>
                    <br/>Double-click an item to copy to clipboard...
                </p>
            </div>
            
            <div class="items-container">
                <div class="items-grid" id="itemsGrid">
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <p>Select a bucket to view items</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Bucket Modal -->
    <div class="modal" id="newBucketModal">
        <div class="modal-content">
            <h3>Create New Bucket</h3>
            <input type="text" id="bucketNameInput" placeholder="Enter bucket name..." maxlength="50">
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="hideNewBucketModal()">Cancel</button>
                <button class="modal-btn primary" onclick="createBucket()">Create</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Initialize socket connection
        const socket = io();
        
        // Global state
        let currentBucket = null;
        let buckets = [];

        // Initialize the app
        async function init() {
            await loadBuckets();
            setupEventListeners();
            
            // Select first bucket by default
            if (buckets.length > 0) {
                selectBucket(buckets[0].id);
            }
        }

        // Load buckets from server
        async function loadBuckets() {
            try {
                const response = await fetch('/api/buckets');
                buckets = await response.json();
                renderBuckets();
            } catch (error) {
                showNotification('Failed to load buckets', 'error');
                console.error('Error loading buckets:', error);
            }
        }

        // Load specific bucket
        async function loadBucket(bucketId) {
            try {
                const response = await fetch(`/api/buckets/${bucketId}`);
                if (!response.ok) {
                    throw new Error('Bucket not found');
                }
                currentBucket = await response.json();
                renderBucket();
            } catch (error) {
                showNotification('Failed to load bucket', 'error');
                console.error('Error loading bucket:', error);
            }
        }

        // Render buckets list
        function renderBuckets() {
            const bucketList = document.getElementById('bucketList');
            
            if (buckets.length === 0) {
                bucketList.innerHTML = '<div class="loading">No buckets found</div>';
                return;
            }

            bucketList.innerHTML = buckets.map(bucket => `
                <div class="bucket-item ${currentBucket?.id === bucket.id ? 'active' : ''}" 
                     onclick="selectBucket('${bucket.id}')">
                    <div class="bucket-name">${bucket.name}</div>
                    <div class="bucket-info">${bucket.itemCount} items</div>
                </div>
            `).join('');
        }

        // Select bucket
        async function selectBucket(bucketId) {
            await loadBucket(bucketId);
            renderBuckets(); // Re-render to update active state
        }

        // Render current bucket
        function renderBucket() {
            const bucketNameEl = document.getElementById('currentBucketName');
            const itemsGrid = document.getElementById('itemsGrid');

            if (!currentBucket) {
                bucketNameEl.textContent = 'Select a bucket';
                itemsGrid.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><p>Select a bucket to view items</p></div>';
                return;
            }

            bucketNameEl.textContent = currentBucket.name;

            if (currentBucket.items.length === 0) {
                itemsGrid.innerHTML = '<div class="empty-state"><div class="empty-icon">üìù</div><p>No items yet. Paste something to get started!</p></div>';
                return;
            }

            itemsGrid.innerHTML = currentBucket.items.map(item => `
                <div class="item-card" data-id="${item.id}" data-type="${item.type}">
                    <div class="item-header" style="display: none;">
                        <span class="item-type">${item.type}</span>
                        <span class="item-timestamp">${formatTimestamp(item.timestamp)}</span>
                    </div>
                    <div class="item-content">
                        ${item.type === 'text' ? 
                            `<div class="item-text">${escapeHtml(item.content)}</div>` :
                            `<img class="item-image" src="data:image/png;base64,${item.content}" alt="Pasted image">`
                        }
                    </div>
                    <div class="item-actions">
                        <button class="copy-btn" onclick="copyItem('${item.id}', '${item.type}')">
                            üìã Copy
                        </button>
                        <button class="delete-btn" onclick="deleteItem('${item.id}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Copy item to clipboard
        async function copyItem(itemId, itemType) {
            const item = currentBucket.items.find(i => i.id === itemId);
            if (!item) return;

            try {
                if (itemType === 'text') {
                    await navigator.clipboard.writeText(item.content);
                } else if (itemType === 'image') {
                    // Convert base64 to blob
                    const response = await fetch(`data:image/png;base64,${item.content}`);
                    const blob = await response.blob();
                    await navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]);
                }
                showNotification('Copied to clipboard!');
            } catch (error) {
                showNotification('Failed to copy to clipboard', 'error');
                console.error('Error copying:', error);
            }
        }

        // Delete item
        async function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            try {
                const response = await fetch(`/api/buckets/${currentBucket.id}/items/${itemId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete');
                
                showNotification('Item deleted');
            } catch (error) {
                showNotification('Failed to delete item', 'error');
                console.error('Error deleting item:', error);
            }
        }

        // Handle paste events
        async function handlePaste(event) {
            if (!currentBucket) {
                showNotification('Please select a bucket first', 'error');
                return;
            }

            const items = event.clipboardData?.items;
            if (!items) return;

            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const base64 = e.target.result.split(',')[1];
                            await addItem('image', base64);
                        };
                        reader.readAsDataURL(file);
                    }
                } else if (item.type === 'text/plain') {
                    item.getAsString(async (text) => {
                        if (text.trim()) {
                            await addItem('text', text.trim());
                        }
                    });
                }
            }
        }

        // Add new item
        async function addItem(type, content) {
            try {
                const response = await fetch(`/api/buckets/${currentBucket.id}/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type, content })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add item');
                }

                showNotification(`${type} added successfully!`);
            } catch (error) {
                showNotification(error.message, 'error');
                console.error('Error adding item:', error);
            }
        }

        // Show/hide new bucket modal
        function showNewBucketModal() {
            document.getElementById('newBucketModal').classList.add('show');
            document.getElementById('bucketNameInput').focus();
        }

        function hideNewBucketModal() {
            document.getElementById('newBucketModal').classList.remove('show');
            document.getElementById('bucketNameInput').value = '';
        }

        // Create new bucket
        async function createBucket() {
            const nameInput = document.getElementById('bucketNameInput');
            const name = nameInput.value.trim();

            if (!name) {
                showNotification('Please enter a bucket name', 'error');
                return;
            }

            try {
                const response = await fetch('/api/buckets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create bucket');
                }

                const newBucket = await response.json();
                hideNewBucketModal();
                showNotification('Bucket created successfully!');
                selectBucket(newBucket.id);
            } catch (error) {
                showNotification(error.message, 'error');
                console.error('Error creating bucket:', error);
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Utility functions
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Setup event listeners
        function setupEventListeners() {

            // double-click to copy
            document.getElementById('itemsGrid').addEventListener('dblclick', (event) => {
                // Find the closest item-card parent
                const card = event.target.closest('.item-card');
                
                // Check if a card was double-clicked
                if (card) {
                    const itemId = card.dataset.id;
                    const itemType = card.dataset.type;
                    
                    // Call existing copy function
                    copyItem(itemId, itemType);
                }
            });

            // Paste event
            document.addEventListener('paste', handlePaste);

            // Drag and drop
            document.addEventListener('dragover', (e) => e.preventDefault());
            document.addEventListener('drop', async (e) => {
                e.preventDefault();
                
                if (!currentBucket) {
                    showNotification('Please select a bucket first', 'error');
                    return;
                }

                const files = e.dataTransfer.files;
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const base64 = e.target.result.split(',')[1];
                            await addItem('image', base64);
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'text/plain') {
                        const text = await file.text();
                        if (text.trim()) {
                            await addItem('text', text.trim());
                        }
                    }
                }
            });

            // Modal keyboard events
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideNewBucketModal();
                } else if (e.key === 'Enter' && document.getElementById('newBucketModal').classList.contains('show')) {
                    createBucket();
                }
            });

            // Socket events
            socket.on('bucketsUpdated', (updatedBuckets) => {
                buckets = updatedBuckets;
                renderBuckets();
            });

            socket.on('bucketUpdated', (updatedBucket) => {
                if (currentBucket && currentBucket.id === updatedBucket.id) {
                    currentBucket = updatedBucket;
                    renderBucket();
                }
                
                // Update bucket list item count
                const bucketIndex = buckets.findIndex(b => b.id === updatedBucket.id);
                if (bucketIndex !== -1) {
                    buckets[bucketIndex].itemCount = updatedBucket.items.length;
                    renderBuckets();
                }
            });

            socket.on('connect', () => {
                console.log('Connected to server');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                showNotification('Connection lost. Trying to reconnect...', 'error');
            });

            socket.on('reconnect', () => {
                console.log('Reconnected to server');
                showNotification('Reconnected!');
                loadBuckets(); // Refresh data
            });

        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>